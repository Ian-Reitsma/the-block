<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Operations - The-Block Documentation</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The-Block Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="operations-runbooks-fast-mainnet"><a class="header" href="#operations-runbooks-fast-mainnet">Operations Runbooks: Fast-Mainnet</a></h1>
<p><strong>Purpose</strong>: Step-by-step troubleshooting guides for operational issues<br />
<strong>Audience</strong>: Site Reliability Engineers, Launch Operations Team<br />
<strong>Related</strong>: <code>docs/OBSERVABILITY_MAP.md</code> (mapping questions to metrics)</p>
<hr />
<h2 id="telemetry-wiring"><a class="header" href="#telemetry-wiring">Telemetry Wiring</a></h2>
<h3 id="runtime-reactor"><a class="header" href="#runtime-reactor">Runtime Reactor</a></h3>
<ul>
<li><code>runtime_read_without_ready_total</code> increments when reads succeed without a readiness event (missed IO wakeups). Sustained growth indicates reactor/event-mapping issues.</li>
<li><code>runtime_write_without_ready_total</code> increments when writes succeed without a readiness event (missed IO wakeups). Sustained growth indicates reactor/event-mapping issues.</li>
</ul>
<h3 id="runtime-tuning-knobs"><a class="header" href="#runtime-tuning-knobs">Runtime Tuning Knobs</a></h3>
<ul>
<li><code>runtime.reactor_idle_poll_ms</code>: maximum sleep between reactor polls (ms).</li>
<li><code>runtime.io_read_backoff_ms</code>: fallback delay before retrying reads when readiness is missing (ms).</li>
<li><code>runtime.io_write_backoff_ms</code>: fallback delay before retrying writes when readiness is missing (ms).</li>
<li><strong>Defaults:</strong> <code>reactor_idle_poll_ms=100</code>, <code>io_read_backoff_ms=10</code>, <code>io_write_backoff_ms=10</code>.</li>
<li><strong>When to tune:</strong> Lower the idle poll and backoff values for latency-sensitive testnets; raise them when CPU is saturated by idle peers. Watch <code>runtime_read_without_ready_total</code> / <code>runtime_write_without_ready_total</code> and reactor CPU to validate changes.</li>
<li><strong>BSD note:</strong> On kqueue platforms we run level-triggered mode (no <code>EV_CLEAR</code>); if wakeups are missed, increase the backoff and ensure <code>update_interest()</code> instrumentation is present.</li>
<li><strong>Env vars:</strong> <code>TB_REACTOR_IDLE_POLL_MS</code>, <code>TB_IO_READ_BACKOFF_MS</code>, and <code>TB_IO_WRITE_BACKOFF_MS</code> map to the same knobs; config reloads apply without restart.</li>
</ul>
<h3 id="p2p-rate-limiting-and-chain-sync"><a class="header" href="#p2p-rate-limiting-and-chain-sync">P2P Rate Limiting and Chain Sync</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Knob</th><th>Default</th><th>Description</th></tr></thead><tbody>
<tr><td><code>p2p_rate_window_secs</code> (<code>TB_P2P_RATE_WINDOW_SECS</code>)</td><td>1</td><td>Sliding window for request counters</td></tr>
<tr><td><code>p2p_max_per_sec</code> (<code>TB_P2P_MAX_PER_SEC</code>)</td><td>workload-dependent</td><td>Max requests per peer per window</td></tr>
<tr><td><code>p2p_max_bytes_per_sec</code> (<code>TB_P2P_MAX_BYTES_PER_SEC</code>)</td><td>workload-dependent</td><td>Max bytes per peer per window</td></tr>
<tr><td><code>p2p_chain_sync_interval_ms</code> (<code>TB_P2P_CHAIN_SYNC_INTERVAL_MS</code>)</td><td>500</td><td>Periodic chain sync pull interval</td></tr>
</tbody></table>
</div>
<ul>
<li>Use narrow windows and lower maxima during incident response; widen for WAN drills. Keep <code>p2p_chain_sync_interval_ms</code> at 0 in isolation tests to prevent periodic pulls.</li>
</ul>
<h3 id="config-hot-reload-fallback"><a class="header" href="#config-hot-reload-fallback">Config Hot-Reload Fallback</a></h3>
<ul>
<li>Config watcher prefers inotify/kqueue; when unavailable, it falls back to mtime polling. On platforms without reliable fs events, expect up to one poll interval of delay before reload. Documented in <code>node/src/config.rs</code>; operators can reduce the poll interval for faster propagation.</li>
</ul>
<h3 id="tls-handshake-timeouts"><a class="header" href="#tls-handshake-timeouts">TLS Handshake Timeouts</a></h3>
<ul>
<li>HTTP servers use <code>ServerConfig.tls_handshake_timeout</code> for TLS handshakes.</li>
<li>HTTP clients use <code>ClientConfig.tls_handshake_timeout</code> or <code>TlsConnectorBuilder::handshake_timeout</code>.</li>
<li>Environment override: <code>TB_TLS_HANDSHAKE_TIMEOUT_MS</code> (milliseconds).</li>
</ul>
<h2 id="treasury-stuck"><a class="header" href="#treasury-stuck">Treasury Stuck</a></h2>
<h3 id="symptoms"><a class="header" href="#symptoms">Symptoms</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
<code>treasury_disbursement_backlog &gt; 50</code> for 2+ epochs</li>
<li><input disabled="" type="checkbox"/>
<code>treasury_disbursement_lag_seconds_p95 &gt; 300</code></li>
<li><input disabled="" type="checkbox"/>
Executor reports <code>last_error != null</code></li>
<li><input disabled="" type="checkbox"/>
Stale disbursements (created_at &gt; 3 days ago, still Queued)</li>
<li><input disabled="" type="checkbox"/>
No state transitions occurring</li>
</ul>
<h3 id="diagnosis"><a class="header" href="#diagnosis">Diagnosis</a></h3>
<p><strong>Step 1</strong>: Check executor health</p>
<pre><code class="language-bash">contract-cli gov treasury balance | jq .executor
# Look for:
#   last_error: string (should be null)
#   last_success_at: recent timestamp
#   pending_matured: count of ready-to-execute
#   lease_holder: node_a (should be active node)
#   lease_expires_at: future timestamp
</code></pre>
<p><strong>Step 2</strong>: List stuck disbursements</p>
<pre><code class="language-bash">echo "=== Disbursements stuck for &gt;1 hour ==="
contract-cli gov treasury list --limit 200 --status queued | jq \
  '.disbursements[] | select(.created_at &lt; (now - 3600)) | {id, created_at, updated_at}'

echo "=== Count stuck disbursements ==="
contract-cli gov treasury list --limit 200 --status queued | jq \
  '.disbursements | length'
</code></pre>
<p><strong>Step 3</strong>: Check for dependency failures</p>
<pre><code class="language-bash">echo "=== Queued disbursements with dependencies ==="
contract-cli gov treasury list --status queued --limit 50 | while read id; do
  deps=$(contract-cli gov treasury show --id "$id" | jq '.proposal.deps')
  if [ "$deps" != "[]" ]; then
    echo "ID $id depends on: $deps"
    # Check if dependencies are satisfied
    echo "$deps" | jq '.[]' | while read dep_id; do
      state=$(contract-cli gov treasury show --id "$dep_id" | jq -r '.status.state')
      echo "  ↳ Dependency $dep_id: $state"
    done
  fi
done
</code></pre>
<p><strong>Step 4</strong>: Inspect error logs</p>
<pre><code class="language-bash">echo "=== Recent treasury executor errors ==="
grep "treasury_executor\|DisbursementError" /var/log/node/*.log \
  | grep -E "ERROR|WARN" \
  | tail -50

echo "=== Executor tick duration ==="
prometheus_query 'histogram_quantile(0.99, treasury_executor_tick_duration_seconds_bucket)'

echo "=== Execution error rate ==="
prometheus_query 'rate(treasury_execution_errors_total[5m])'
</code></pre>
<p><strong>Step 5</strong>: Check treasury balance</p>
<pre><code class="language-bash">contract-cli gov treasury balance | jq '{balance}'

# If insufficient, show what's waiting to execute
echo "=== Pending disbursements (sum of amounts) ==="
contract-cli gov treasury list --status queued --limit 200 | jq \
  '.disbursements | map(.amount) | add'
</code></pre>
<h3 id="resolution-paths"><a class="header" href="#resolution-paths">Resolution Paths</a></h3>
<h4 id="path-a-dependency-issue"><a class="header" href="#path-a-dependency-issue"><strong>Path A: Dependency Issue</strong></a></h4>
<p><strong>Indicators</strong>: Dependencies in wrong state</p>
<pre><code class="language-bash"># List dependencies and their states
contract-cli gov treasury show --id &lt;STUCK_ID&gt; | jq '{id: .id, deps: .proposal.deps}'

# For each dependency, check state
for dep_id in $(contract-cli gov treasury show --id &lt;STUCK_ID&gt; | jq -r '.proposal.deps[]'); do
  state=$(contract-cli gov treasury show --id "$dep_id" | jq -r '.status.state')
  echo "Dependency $dep_id: $state"
  
  if [ "$state" = "rolled_back" ]; then
    echo "  ✗ Dependency failed. Cancelling dependent..."
    # Cancel the stuck disbursement
    contract-cli gov treasury rollback --id &lt;STUCK_ID&gt; \
      --reason "Dependency $dep_id was rolled back"
  fi
done
</code></pre>
<h4 id="path-b-insufficient-funds"><a class="header" href="#path-b-insufficient-funds"><strong>Path B: Insufficient Funds</strong></a></h4>
<p><strong>Indicators</strong>: <code>treasury_execution_errors_total{reason="insufficient_funds"}</code> increasing</p>
<pre><code class="language-bash"># Check current balance
current=$(contract-cli gov treasury balance | jq .balance)
pending=$(contract-cli gov treasury list --status queued | jq '[.disbursements[].amount] | add')

echo "Current balance: $current BLOCK"
echo "Pending disbursements: $pending BLOCK"

if [ $current -lt $pending ]; then
  echo "INSUFFICIENT FUNDS"
  echo "Wait for accruals: watch -n 30 'contract-cli gov treasury balance | jq .balance'"
  echo "OR request governance approval for fund allocation"
fi
</code></pre>
<h4 id="path-c-executor-error"><a class="header" href="#path-c-executor-error"><strong>Path C: Executor Error</strong></a></h4>
<p><strong>Indicators</strong>: <code>last_error != null</code>, executor not progressing</p>
<pre><code class="language-bash"># Get the exact error
error=$(contract-cli gov treasury balance | jq -r '.executor.last_error')
echo "Executor error: $error"

# Common errors and fixes:
case "$error" in
  "ledger_unavailable")
    echo "Ledger connection lost. Check: systemctl status ledger-node"
    ;;
  "consensus_timeout")
    echo "Consensus stalled. Check: contract-cli node consensus --status"
    ;;
  "dependency_cycle_detected")
    echo "Circular dependency found. Review recent disbursement submissions."
    ;;
  *)
    echo "Unknown error. Check logs: tail -100 /var/log/node/*.log"
    ;;
esac

# Restart executor
echo "Attempting executor restart..."
sudo systemctl restart the-block

# Monitor recovery
echo "Monitoring backlog recovery..."
watch -n 5 'contract-cli gov treasury balance | jq .executor.last_error'
</code></pre>
<h4 id="path-d-data-corruption"><a class="header" href="#path-d-data-corruption"><strong>Path D: Data Corruption</strong></a></h4>
<p><strong>Indicators</strong>: Multiple disbursements stuck with inconsistent states</p>
<pre><code class="language-bash"># Snapshot current state
contract-cli gov treasury list --limit 500 &gt; /tmp/disburse_snapshot_$(date +%s).json
grep "treasury_executor" /var/log/node/*.log &gt; /tmp/executor_logs_$(date +%s).txt

# Contact operations with:
echo "Send to ops team:"
echo "  - /tmp/disburse_snapshot_*.json"
echo "  - /tmp/executor_logs_*.txt"
echo "  - prometheus_dump.json (from curl http://localhost:9090/api/v1/query_range?...)"
echo "  - Describe when issue started"
</code></pre>
<h3 id="alert-thresholds"><a class="header" href="#alert-thresholds">Alert Thresholds</a></h3>
<p><strong>CRITICAL</strong> (Page on-call):</p>
<pre><code class="language-promql"># Backlog accumulating
treasury_disbursement_backlog &gt; 100 for 3 epochs

# Executor failing
rate(treasury_execution_errors_total[5m]) &gt; 1

# No progress for extended period
increase(governance_disbursements_total{status="finalized"}[10m]) == 0
</code></pre>
<p><strong>WARNING</strong> (Create ticket):</p>
<pre><code class="language-promql"># High latency
histogram_quantile(0.95, treasury_disbursement_lag_seconds_bucket) &gt; 600

# Moderate backlog
treasury_disbursement_backlog &gt; 50 for 2 epochs
</code></pre>
<hr />
<h2 id="energy-stalled"><a class="header" href="#energy-stalled">Energy Stalled</a></h2>
<h3 id="symptoms-1"><a class="header" href="#symptoms-1">Symptoms</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
<code>oracle_latency_seconds_p95 &gt; 10</code></li>
<li><input disabled="" type="checkbox"/>
<code>energy_signature_verification_failures_total</code> increasing rapidly (&gt; 1/min)</li>
<li><input disabled="" type="checkbox"/>
<code>energy_pending_credits_total</code> not decreasing</li>
<li><input disabled="" type="checkbox"/>
Provider readings not settling</li>
<li><input disabled="" type="checkbox"/>
Disputes backlog increasing</li>
</ul>
<h3 id="diagnosis-1"><a class="header" href="#diagnosis-1">Diagnosis</a></h3>
<p><strong>Step 1</strong>: Check oracle latency</p>
<pre><code class="language-bash">echo "=== Oracle latency distribution ==="
prometheus_query 'histogram_quantile(0.50, oracle_latency_seconds_bucket)'
prometheus_query 'histogram_quantile(0.95, oracle_latency_seconds_bucket)'
prometheus_query 'histogram_quantile(0.99, oracle_latency_seconds_bucket)'

echo "=== Oracle process status ==="
sudo systemctl status energy-oracle
grep oracle_latency /var/log/oracle/*.log | tail -20
</code></pre>
<p><strong>Step 2</strong>: Check signature verification failures</p>
<pre><code class="language-bash">echo "=== Signature failure rate ==="
prometheus_query 'rate(energy_signature_verification_failures_total[5m])'

echo "=== Recent verification failures ==="
grep "signature_verification_failed\|SignatureInvalid" /var/log/node/*.log | tail -30

echo "=== Breakdown by reason ==="
for reason in invalid_format verification_failed key_not_found scheme_unsupported; do
  count=$(prometheus_query "energy_signature_verification_failures_total{reason=\"$reason\"}" | jq '.data.result[0].value[1]')
  echo "  $reason: $count"
done
</code></pre>
<p><strong>Step 3</strong>: Check meter reading accumulation</p>
<pre><code class="language-bash">echo "=== Pending credits (kWh) ==="
contract-cli energy credits list --status pending --limit 50 | jq \
  '.credits | {total_kwh: map(.amount_kwh) | add, count: length}'

echo "=== Credits by provider ==="
contract-cli energy credits list --status pending --limit 200 | jq \
  '.credits | group_by(.provider_id) | map({provider: .[0].provider_id, count: length, total_kwh: map(.amount_kwh) | add})'
</code></pre>
<p><strong>Step 4</strong>: Check for timestamp issues</p>
<pre><code class="language-bash">echo "=== Timestamp skew errors ==="
grep "timestamp_skew\|TimestampSkew" /var/log/node/*.log | wc -l

echo "=== System clock status ==="
timedatectl
ntpq -p

echo "=== Provider clock differences ==="
for provider in $(contract-cli energy market | jq -r '.providers[].provider_id' | head -10); do
  last_reading=$(contract-cli energy provider show "$provider" | jq .last_settlement)
  echo "$provider: $last_reading"
done
</code></pre>
<p><strong>Step 5</strong>: Check provider status</p>
<pre><code class="language-bash">echo "=== Inactive providers ==="
contract-cli energy market | jq '.providers[] | select(.status != "active") | {provider_id, status, reputation_score}'

echo "=== Providers with poor reputation ==="
contract-cli energy market | jq '.providers[] | select(.reputation.composite_score &lt; 0.5) | {provider_id, score: .reputation.composite_score}'
</code></pre>
<h3 id="resolution-paths-1"><a class="header" href="#resolution-paths-1">Resolution Paths</a></h3>
<h4 id="path-a-oracle-latency-high"><a class="header" href="#path-a-oracle-latency-high"><strong>Path A: Oracle Latency High</strong></a></h4>
<p><strong>Indicators</strong>: p95 latency &gt; 10 seconds</p>
<pre><code class="language-bash"># Check oracle CPU and memory
ps aux | grep oracle
top -p $(pgrep -f oracle)

# Check oracle queue depth
grep "pending_verifications\|queue_depth" /var/log/oracle/*.log | tail -10

# Scale oracle if needed (multiple instances)
echo "Consider: kubectl scale deployment energy-oracle --replicas=3"

# Monitor improvement
watch -n 5 'prometheus_query "histogram_quantile(0.95, oracle_latency_seconds_bucket)"'
</code></pre>
<h4 id="path-b-signature-verification-failures"><a class="header" href="#path-b-signature-verification-failures"><strong>Path B: Signature Verification Failures</strong></a></h4>
<p><strong>Indicators</strong>: Failures &gt; 1/min, reason = "verification_failed" or "invalid_format"</p>
<pre><code class="language-bash"># Check provider keys
echo "=== Checking oracle key manager ==="
contract-cli energy oracle keys status

# Verify provider public keys in registry
for provider in $(contract-cli energy market | jq -r '.providers[].provider_id' | head -5); do
  key=$(contract-cli energy provider show "$provider" | jq .public_key)
  echo "$provider: $key"
done

# Test a signature manually
echo "=== Testing signature generation ==="
cat &gt; /tmp/test_sig.py &lt;&lt; 'EOF'
import ed25519, struct, base64, time

provider_id = "provider_usa_001"
meter = "meter_001"
total_kwh = 1500000
timestamp = int(time.time())
nonce = 12345

# Build message
message = (
    provider_id.encode() +
    meter.encode() +
    struct.pack('&lt;Q', total_kwh) +
    struct.pack('&lt;Q', timestamp) +
    struct.pack('&lt;Q', nonce)
)

# Test signature
signing_key = ed25519.SigningKey(base64.b64decode("&lt;PRIVATE_KEY&gt;"))
signature = signing_key.sign(message).signature
print(f"Signature: {base64.b64encode(signature)}")
EOF
python /tmp/test_sig.py
</code></pre>
<h4 id="path-c-timestamp-skew"><a class="header" href="#path-c-timestamp-skew"><strong>Path C: Timestamp Skew</strong></a></h4>
<p><strong>Indicators</strong>: "timestamp_skew" errors in logs</p>
<pre><code class="language-bash"># Check system clock on provider and oracle
echo "=== Provider nodes ==="
for node in provider_node_1 provider_node_2 oracle_node; do
  echo "$node:"
  ssh "$node" 'date; timedatectl'
done

# Fix time drift
echo "Syncing clocks with NTP..."
sudo ntpdate -u ntp.ubuntu.com  # or your NTP server

# Verify sync
timedatectl
for node in provider_node_1 provider_node_2; do
  ssh "$node" 'timedatectl'
done

# Monitor recovery
watch -n 10 'grep timestamp_skew /var/log/node/*.log | tail -5'
</code></pre>
<h4 id="path-d-provider-reputation-degradation"><a class="header" href="#path-d-provider-reputation-degradation"><strong>Path D: Provider Reputation Degradation</strong></a></h4>
<p><strong>Indicators</strong>: Multiple providers with score &lt; 0.5</p>
<pre><code class="language-bash"># Check what caused reputation drops
echo "=== Recent disputes ==="
contract-cli energy disputes list --limit 20

# Check slashing events
echo "=== Recent slashing ==="
prometheus_query 'rate(energy_slashing_total[24h])' | jq '.data.result[] | {provider, reason: .metric.reason, rate: .value}'

# Review evidence
for dispute_id in $(contract-cli energy disputes list --status resolved | jq -r '.disputes[].dispute_id' | head -5); do
  echo "Dispute $dispute_id:"
  contract-cli energy disputes show --id "$dispute_id"
done
</code></pre>
<h3 id="alert-thresholds-1"><a class="header" href="#alert-thresholds-1">Alert Thresholds</a></h3>
<p><strong>CRITICAL</strong> (Page on-call):</p>
<pre><code class="language-promql"># Oracle broken
oracle_latency_seconds_p95 &gt; 30
energy_signature_verification_failures_total &gt; 10

# Settlement stalled
increase(energy_settlements_total[10m]) == 0

# Dispute backlog critical
energy_active_disputes_total &gt; 50
</code></pre>
<p><strong>WARNING</strong> (Create ticket):</p>
<pre><code class="language-promql">oracle_latency_seconds_p95 &gt; 10
rate(energy_signature_verification_failures_total[5m]) &gt; 1
energy_active_disputes_total &gt; 20
</code></pre>
<hr />
<h2 id="receipts-flatlining"><a class="header" href="#receipts-flatlining">Receipts Flatlining</a></h2>
<h3 id="symptoms-2"><a class="header" href="#symptoms-2">Symptoms</a></h3>
<ul>
<li><input disabled="" type="checkbox"/>
<code>receipt_emitted_total</code> flat or decreasing for 5+ blocks</li>
<li><input disabled="" type="checkbox"/>
One or more markets (storage, compute, energy, ad) not emitting</li>
<li><input disabled="" type="checkbox"/>
<code>receipt_validation_errors_total</code> increasing</li>
<li><input disabled="" type="checkbox"/>
Explorer receipt tables not updating</li>
</ul>
<h3 id="diagnosis-2"><a class="header" href="#diagnosis-2">Diagnosis</a></h3>
<p><strong>Step 1</strong>: Check emission rates by market</p>
<pre><code class="language-bash">echo "=== Receipt emission rate (1m) ==="
prometheus_query 'rate(receipt_emitted_total[1m])' | jq '.data.result[] | {market: .metric.market, rate: .value[1]}'

echo "=== Markets with no emissions (last 10 blocks) ==="
prometheus_query 'increase(receipt_emitted_total[10m]) == 0' | jq '.data.result[].metric'
</code></pre>
<p><strong>Step 2</strong>: Check validation errors</p>
<pre><code class="language-bash">echo "=== Validation error rate ==="
prometheus_query 'rate(receipt_validation_errors_total[5m])'

echo "=== Error breakdown by reason ==="
for reason in schema_mismatch duplicate_detection signature_invalid; do
  count=$(prometheus_query "receipt_validation_errors_total{reason=\"$reason\"}" | jq '.data.result[0].value[1]')
  echo "  $reason: $count"
done
</code></pre>
<p><strong>Step 3</strong>: Per-market diagnostics</p>
<pre><code class="language-bash"># Storage market
echo "=== Storage market ==="
contract-cli receipts stats --market storage
grep storage /var/log/node/receipts.log | tail -20

# Compute market
echo "=== Compute market ==="
contract-cli receipts stats --market compute
grep compute /var/log/node/receipts.log | tail -20

# Energy market
echo "=== Energy market ==="
contract-cli receipts stats --market energy
grep energy /var/log/node/receipts.log | tail -20

# Ad market
echo "=== Ad market ==="
contract-cli receipts stats --market ad
grep ad /var/log/node/receipts.log | tail -20
</code></pre>
<p><strong>Step 4</strong>: Check block height and progression</p>
<pre><code class="language-bash">echo "=== Current block ==="
contract-cli node status | jq '.current_block_height'

echo "=== Block progression (last 50 blocks) ==="
prometheus_query 'increase(block_height_total[50m])'

echo "=== Consensus status ==="
contract-cli node consensus --status
</code></pre>
<h3 id="resolution"><a class="header" href="#resolution">Resolution</a></h3>
<p><strong>For stalled markets</strong>:</p>
<pre><code class="language-bash"># Restart receipt emitter
sudo systemctl restart receipt-emitter

# Monitor recovery
watch -n 5 'contract-cli receipts stats --market storage'

# If persists, check market-specific service
for market in storage compute energy ad; do
  sudo systemctl status "${market}-market"
done
</code></pre>
<p><strong>For validation errors</strong>:</p>
<pre><code class="language-bash"># Clear validation state (if safe)
contract-cli receipts reset-validation-state

# Re-validate last N blocks
contract-cli receipts validate --from-block $((
  $(contract-cli node status | jq .current_block_height) - 100
))

# Monitor
watch -n 10 'prometheus_query "receipt_validation_errors_total"'
</code></pre>
<hr />
<h2 id="explorer-treasury-schema-migration"><a class="header" href="#explorer-treasury-schema-migration">Explorer Treasury Schema Migration</a></h2>
<p>Run this playbook whenever the explorer SQLite database still contains the legacy <code>amount</code>/<code>amount_it</code> columns in <code>treasury_disbursements</code>.</p>
<ol>
<li><strong>Stop explorer</strong> so the migration can take an exclusive lock on the DB file.</li>
<li>Run the helper (defaults to <code>explorer.db</code> in the current directory):
<pre><code class="language-bash">cargo run -p explorer --bin explorer-migrate-treasury -- /var/lib/explorer/explorer.db
</code></pre>
The tool applies the three <code>ALTER TABLE</code> statements (<code>ADD COLUMN status_payload</code>, <code>RENAME COLUMN amount TO amount</code>, <code>DROP COLUMN amount_it</code>). Statements that have already landed are reported as <code>skipped</code>.</li>
<li>Restart explorer, then validate <code>/governance/treasury/disbursements</code> and the treasury dashboards before announcing completion.</li>
</ol>
<hr />
<h2 id="settlement-audit"><a class="header" href="#settlement-audit">Settlement Audit</a></h2>
<h3 id="how-to-run"><a class="header" href="#how-to-run">How to Run</a></h3>
<pre><code class="language-bash"># Standard settlement audit
cargo test -p the_block --test settlement_audit --release -- --nocapture

# With specific options
STARTING_EPOCH=0 ENDING_EPOCH=1000 cargo test \
  -p the_block --test settlement_audit --release -- --nocapture

# Verbose output
RUST_LOG=debug cargo test -p the_block --test settlement_audit --release -- --nocapture
</code></pre>
<h3 id="interpreting-results"><a class="header" href="#interpreting-results">Interpreting Results</a></h3>
<p><strong>Successful audit</strong>:</p>
<pre><code>test settlement_audit ... ok

Ledger conservation verified:
  Initial balance: 10,000,000 BLOCK
  Accruals: 1,500,000 BLOCK
  Executed disbursements: 2,000,000 BLOCK
  Final balance: 9,500,000 BLOCK
</code></pre>
<p><strong>Failed audit</strong> (example):</p>
<pre><code>test settlement_audit ... FAILED

Assertion failed:
  Expected balance: 9,500,000 BLOCK
  Actual balance: 9,300,000 BLOCK
  Discrepancy: 200,000 BLOCK (2.1%)

Investigation:
  1. Find missing disbursement: ID 4521
  2. Check status: Executed but not credited
  3. Verify: Receipt exists? Yes. Target account? Valid.
  4. Root cause: Ledger index out of sync
</code></pre>
<h3 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h3>
<p><strong>If audit fails</strong>:</p>
<pre><code class="language-bash"># Get detailed logs
cargo test -p the_block --test settlement_audit --release -- --nocapture --test-threads=1 2&gt;&amp;1 | tee settlement_audit.log

# Extract specific disbursement details
grep "Disbursement 4521" settlement_audit.log

# Check ledger state
contract-cli node ledger inspect --account treasury_account_id

# Verify receipts associated with missing disbursement
grep "disbursement_id.*4521" /var/log/node/*.log
</code></pre>
<hr />
<h2 id="helper-functions"><a class="header" href="#helper-functions">Helper Functions</a></h2>
<h3 id="prometheus_query"><a class="header" href="#prometheus_query">prometheus_query()</a></h3>
<p><strong>Purpose</strong>: Query Prometheus for metric values</p>
<p><strong>Usage</strong>:</p>
<pre><code class="language-bash">prometheus_query 'up{instance="localhost:9090"}'
prometheus_query 'histogram_quantile(0.95, request_duration_seconds_bucket)'
</code></pre>
<p><strong>Implementation</strong>:</p>
<pre><code class="language-bash">prometheus_query() {
  local query="$1"
  local url="${PROMETHEUS_URL:-http://localhost:9090}"
  curl -s "${url}/api/v1/query" \
    --data-urlencode "query=${query}" | \
    jq -r '.data.result[0].value[1] // "no data"'
}
</code></pre>
<p><strong>Configuration</strong>:</p>
<pre><code class="language-bash">export PROMETHEUS_URL="http://prometheus.infra.internal:9090"
</code></pre>
<hr />
<h2 id="slo-definitions"><a class="header" href="#slo-definitions">SLO Definitions</a></h2>
<h3 id="treasury-system"><a class="header" href="#treasury-system">Treasury System</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Alert Threshold</th></tr></thead><tbody>
<tr><td>Availability</td><td>99.95%</td><td>Errors &gt; 0.1% for 5 min</td></tr>
<tr><td>Execution Latency p95</td><td>&lt; 300s</td><td>&gt; 600s for 10 min</td></tr>
<tr><td>Error Rate</td><td>&lt; 0.1%</td><td>&gt; 1 error/sec</td></tr>
<tr><td>Queue Depth</td><td>&lt; 100</td><td>&gt; 100 for 3 epochs</td></tr>
</tbody></table>
</div>
<h3 id="energy-system"><a class="header" href="#energy-system">Energy System</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Alert Threshold</th></tr></thead><tbody>
<tr><td>Oracle Latency p95</td><td>&lt; 5s</td><td>&gt; 10s for 5 min</td></tr>
<tr><td>Signature Validation</td><td>&gt; 99.9%</td><td>&gt; 1 failure/min</td></tr>
<tr><td>Settlement Rate</td><td>&gt; 95%</td><td>&lt; 90% for 10 min</td></tr>
<tr><td>Dispute Resolution</td><td>&lt; 1 hour</td><td>Unresolved &gt; 2 hours</td></tr>
</tbody></table>
</div>
<h3 id="receipts-system"><a class="header" href="#receipts-system">Receipts System</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Alert Threshold</th></tr></thead><tbody>
<tr><td>Emission Rate</td><td>All markets</td><td>Any market = 0 for 5 blocks</td></tr>
<tr><td>Validation Success</td><td>&gt; 99.99%</td><td>&lt; 99% for 10 min</td></tr>
<tr><td>Storage</td><td>All receipts</td><td>Storage &gt; 1 week</td></tr>
<tr><td>Query Latency p99</td><td>&lt; 100ms</td><td>&gt; 500ms for 5 min</td></tr>
</tbody></table>
</div>
<hr />
<p><strong>Last Updated</strong>: 2025-12-19<br />
<strong>Next Review</strong>: 2025-12-26<br />
<strong>Maintainer</strong>: Operations Team</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="economics_and_governance.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="security_and_privacy.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="economics_and_governance.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="security_and_privacy.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
