
name: ci
on:
  pull_request:

env:
  FSTAR_VERSION: v2025.08.07

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: '1.86.0'
          override: true
      - uses: Swatinem/rust-cache@v2
      - id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            monitoring:
              - 'monitoring/**'
              - 'node/src/telemetry.rs'
        - name: install monitoring deps
          run: npm ci --prefix monitoring
        - name: monitor smoke
          run: |
            set -e
            make monitor --native-monitor &
            pid=$!
            sleep 5
            kill $pid
            wait $pid || true
      - name: lint grafana dashboard
        if: steps.changes.outputs.monitoring == 'true'
        run: |
          set -o pipefail
          make -C monitoring lint 2>&1 | tee monitoring/lint.log
      - name: verify dashboard up-to-date
        if: steps.changes.outputs.monitoring == 'true'
        run: git diff --exit-code monitoring/metrics.json monitoring/grafana/dashboard.json
      - name: upload grafana lint log
        if: always() && steps.changes.outputs.monitoring == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-lint
          path: monitoring/lint.log
      - name: install fstar
        run: scripts/install_fstar.sh
      - name: fstar installer failure check
        run: scripts/test_install_fstar.sh
      - name: install python runtime
        run: |
          sudo apt-get update
          sudo apt-get install -y patchelf software-properties-common
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update
          sudo apt-get install -y python3.12 python3.12-dev
      - name: install just and demo venv
        run: |
          cargo install just --locked
          python3.12 -m venv .venv
      - name: demo smoke test
        run: just demo
      - name: discover libpython
        run: |
          echo "LIBPYTHON_PATH=$(python3-config --ldflags | sed -n 's/.*-L\([^ ]*\).*/\1/p')" >> $GITHUB_ENV
      - name: install cargo-nextest
        run: cargo install cargo-nextest --locked
      - name: verify cargo-nextest
        run: cargo nextest --version
      - name: cargo nextest
        run: |
          cargo nextest run --profile quic --features telemetry 2>&1 | tee quic-nextest.log
        env:
          LD_LIBRARY_PATH: ${{ env.LIBPYTHON_PATH }}
      - name: upload quic nextest log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quic-nextest
          path: quic-nextest.log
      - name: gossip test
        run: cargo nextest run --profile quic gossip_converges_to_longest_chain --retries 2
        env:
          RUST_TEST_THREADS: 1
          LD_LIBRARY_PATH: ${{ env.LIBPYTHON_PATH }}
      - name: compute-market nextest
        run: cargo nextest run --features telemetry compute_market::courier_retry_updates_metrics price_board
        env:
          LD_LIBRARY_PATH: ${{ env.LIBPYTHON_PATH }}
      - name: doc tests
        run: cargo test --doc --all-features
        env:
          LD_LIBRARY_PATH: ${{ env.LIBPYTHON_PATH }}
      - name: snapshot restore
        run: scripts/snapshot_ci.sh
        env:
          LD_LIBRARY_PATH: ${{ env.LIBPYTHON_PATH }}
  wal-fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          profile: minimal
          override: true
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo
            target
            fuzz/artifacts
            net/fuzz/artifacts
            gateway/fuzz/artifacts
          key: ${{ runner.os }}-wal-fuzz-${{ hashFiles('Cargo.lock') }}
      - name: install cargo-fuzz
        run: cargo install cargo-fuzz --locked
      - name: run wal fuzz
        run: cargo +nightly fuzz run wal_fuzz -- -max_total_time=120 -artifact_prefix=fuzz/wal/ -runs=0 || true
      - name: upload wal artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wal-fuzz
          path: fuzz/wal/
      - name: verify no artifacts
        run: |
          if ls fuzz/wal/* 1> /dev/null 2>&1; then
            echo "Artifacts found";
            exit 1;
          fi
  compute-market-fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          profile: minimal
          override: true
      - uses: actions/cache@v3
        with:
          path: |
            ~/.cargo
            target
            fuzz/artifacts
          key: ${{ runner.os }}-compute-market-fuzz-${{ hashFiles('Cargo.lock') }}
      - name: install cargo-fuzz
        run: cargo install cargo-fuzz --locked
      - name: run compute_market fuzz
        run: cargo +nightly fuzz run compute_market -- -max_total_time=120 -artifact_prefix=fuzz/compute_market/ -runs=0 || true
      - name: run network fuzz
        run: cargo +nightly fuzz run network -- -max_total_time=120 -artifact_prefix=fuzz/network/artifacts/ -runs=0 || true
      - name: run localnet proximity fuzz
        run: cargo +nightly fuzz run localnet_proximity -- -max_total_time=120 -artifact_prefix=fuzz/localnet_proximity/ -runs=0 || true
      - name: run peer id fuzz
        working-directory: net/fuzz
        run: cargo +nightly fuzz run peer_id -- -max_total_time=120 -artifact_prefix=artifacts/ -runs=0 || true
      - name: run gateway http fuzz
        working-directory: gateway/fuzz
        run: cargo +nightly fuzz run http_request -- -max_total_time=120 -artifact_prefix=artifacts/ -runs=0 || true
      - name: fuzz coverage report
        run: scripts/fuzz_coverage.sh
      - name: upload compute-market artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compute-market-fuzz
          path: fuzz/compute_market/
      - name: upload network artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: network-fuzz
          path: fuzz/network/artifacts/
      - name: upload peer-id artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: peer-id-fuzz
          path: net/fuzz/artifacts/
      - name: upload gateway artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gateway-fuzz
          path: gateway/fuzz/artifacts/
      - name: upload fuzz coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzz-coverage
          path: fuzz/coverage
      - name: verify no compute-market artifacts
        run: |
          if ls fuzz/compute_market/* 1> /dev/null 2>&1; then
            echo "Artifacts found";
            exit 1;
          fi
      - name: verify no network artifacts
        run: |
          if ls fuzz/network/artifacts/* 1> /dev/null 2>&1; then
            echo "Artifacts found";
            exit 1;
          fi
      - name: verify no peer-id artifacts
        run: |
          if ls net/fuzz/artifacts/* 1> /dev/null 2>&1; then
            echo "Artifacts found";
            exit 1;
          fi
      - name: verify no gateway artifacts
        run: |
          if ls gateway/fuzz/artifacts/* 1> /dev/null 2>&1; then
            echo "Artifacts found";
            exit 1;
          fi
  settlement-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: '1.86.0'
          override: true
      - uses: Swatinem/rust-cache@v2
      - name: settlement audit
        run: cargo test -p the_block --test settlement_audit --release
