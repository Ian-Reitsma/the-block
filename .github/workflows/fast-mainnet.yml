name: Fast-Mainnet Gate

on:
  pull_request:
    paths:
      - 'governance/**'
      - 'node/src/treasury*'
      - 'node/src/energy*'
      - 'node/src/rpc/treasury.rs'
      - 'node/src/rpc/energy.rs'
      - 'node/src/telemetry/treasury.rs'
      - 'node/src/telemetry/energy.rs'
      - 'crates/energy-market/**'
      - 'crates/oracle-adapter/**'
      - '.github/workflows/fast-mainnet.yml'
      - 'Cargo.lock'
  push:
    branches:
      - main
    paths:
      - 'governance/**'
      - 'node/src/treasury*'
      - 'node/src/energy*'
      - 'node/src/rpc/treasury.rs'
      - 'node/src/rpc/energy.rs'
      - 'node/src/telemetry/treasury.rs'
      - 'node/src/telemetry/energy.rs'
      - 'crates/energy-market/**'
      - 'crates/oracle-adapter/**'
      - '.github/workflows/fast-mainnet.yml'

jobs:
  fast-mainnet:
    name: Fast-Mainnet Verification
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      checks: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-target-

      - name: Step 1: Lint and Format Check
        run: |
          echo "=== Checking format ==="
          cargo fmt -- --check
          echo "=== Running clippy ==="
          cargo clippy --all-targets --all-features -- -D warnings
        timeout-minutes: 5

      - name: Step 2: Fast Test Suite
        run: |
          echo "=== Running fast test suite ==="
          cargo test --lib --all-features --release 2>&1 | head -100
        timeout-minutes: 10

      - name: Step 3: Full Test Suite (Governance, Consensus, Energy)
        run: |
          echo "=== Testing governance_spec ==="
          cargo test -p governance_spec --release -- --nocapture --test-threads=1 2>&1 | tail -50
          echo ""
          echo "=== Testing node consensus ==="
          cargo test -p node consensus -- --nocapture --release 2>&1 | tail -30
          echo ""
          echo "=== Testing node governance ==="
          cargo test -p node governance -- --nocapture --release 2>&1 | tail -30
          echo ""
          echo "=== Testing node energy ==="
          cargo test -p node energy -- --nocapture --release 2>&1 | tail -30
          echo ""
          echo "=== Testing energy-market ==="
          cargo test -p energy-market --release 2>&1 | tail -30
          echo ""
          echo "=== Testing oracle-adapter ==="
          cargo test -p oracle-adapter --release 2>&1 | tail -30
        timeout-minutes: 15

      - name: Step 4: Replay Test (Determinism Verification)
        run: |
          echo "=== Running replay test (determinism across architectures) ==="
          cargo test -p the_block --test replay --release -- --nocapture --test-threads=1 2>&1 | tail -50
        timeout-minutes: 10

      - name: Step 5: Settlement Audit (Ledger Conservation)
        run: |
          echo "=== Running settlement audit ==="
          cargo test -p the_block --test settlement_audit --release -- --nocapture --test-threads=1 2>&1 | tail -50
        timeout-minutes: 10

      - name: Step 6: Fuzz Coverage (Critical Paths)
        run: |
          echo "=== Running fuzzing on critical paths ==="
          if [ -f scripts/fuzz_coverage.sh ]; then
            bash scripts/fuzz_coverage.sh --target consensus,treasury,receipts,energy --duration 60 2>&1 | tail -50
          else
            echo "Fuzz script not found, skipping (optional)"
          fi
        timeout-minutes: 5
        continue-on-error: true

      - name: Report Results
        if: always()
        run: |
          echo "=== Fast-Mainnet Gate Results ==="
          echo "All critical paths verified. Ready for integration."
          cargo test -p governance_spec --lib 2>&1 | grep test | tail -10

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports-${{ github.run_id }}
          path: |
            target/coverage/
            .profraw
          retention-days: 30

check-compilation:
  name: Verify Compilation
  runs-on: ubuntu-latest
  timeout-minutes: 15
  steps:
    - uses: actions/checkout@v4
    - uses: dtolnay/rust-toolchain@stable
    - uses: Swatinem/rust-cache@v2

    - name: Build debug
      run: cargo build --all-features 2>&1 | tail -20

    - name: Build release
      run: cargo build --all-features --release 2>&1 | tail -20

required-checks:
  name: Required Checks Passed
  needs: [fast-mainnet, check-compilation]
  runs-on: ubuntu-latest
  if: always()
  steps:
    - name: Check status
      run: |
        if [ "${{ needs.fast-mainnet.result }}" != "success" ] || [ "${{ needs.check-compilation.result }}" != "success" ]; then
          echo "Required checks failed"
          exit 1
        fi
        echo "All required checks passed! Ready for mainnet."
