name: release-gate

on:
  workflow_call:

jobs:
  gate:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.82.0
          profile: minimal
          override: true
      - uses: taiki-e/setup-nextest@v0
      - name: Unit and integration tests
        run: cargo nextest run --all-features
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          profile: minimal
      - name: WAL fuzz (120s)
        run: cargo +nightly fuzz run wal_fuzz -- -max_total_time=120 -artifact_prefix=fuzz/wal/ -runs=0
      - name: Promote WAL seeds
        run: ./scripts/promote_wal_seeds.sh fuzz/wal fuzz/corpus/wal
      - name: Upload WAL artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wal-fuzz
          path: fuzz/wal/
      - name: Chaos tests
        run: |
          ./scripts/chaos.sh --nodes 3 --duration 30 2>&1 | tee chaos.log
          tar -xf chaos_artifacts.tar.gz
          max=$(rg -o 'rejoin_time_seconds=([0-9]+)' -r '$1' swarm/logs/*.log | sort -nr | head -n1)
          if [ "${max:-0}" -gt 30 ]; then
            echo "rejoin_time_seconds too high: $max" >&2
            exit 1
          fi
      - name: Upload chaos logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chaos-logs
          path: |
            chaos.log
            chaos_artifacts.tar.gz
      - name: Probe suite
        run: ./scripts/synthetic.sh
      - name: Dashboard deps
        run: npm ci --prefix monitoring
      - name: Dashboard lint
        run: make -C monitoring lint
      - name: Alert rule tests
        run: ./scripts/alert_test.sh
      - name: Build release binary
        run: cargo build --release
      - name: Explorer smoke
        run: ./scripts/explorer_smoke.sh
      - name: Generate SBOM
        run: |
          ./scripts/generate_sbom.sh SBOM.json
          cosign attest --predicate SBOM.json --type cyclonedx SBOM.json
      - name: Release provenance
        run: ./scripts/release_provenance.sh test-tag
      - name: Verify attestations
        run: |
          cosign verify-attestation --type cyclonedx SBOM.json
          cosign verify-attestation --type slsa-provenance releases/test-tag/checksums.txt
      - name: Upload SBOM artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            SBOM.json
            releases/test-tag/
      - name: Reproducible build & verify
        run: |
          tar --sort=name --owner=0 --group=0 --numeric-owner --mtime=@$(git log -1 --format=%ct) -C target/release -cf node.tar node
          gzip -n node.tar
          sha256sum node.tar.gz > checksums.txt
          cosign sign-blob --output-signature checksums.txt.sig checksums.txt
          ./scripts/verify_release.sh node.tar.gz checksums.txt checksums.txt.sig
          ! readelf -S target/release/node | grep -q debug
          size=$(stat -c%s target/release/node)
          echo "node_size_bytes=$size" >> $GITHUB_STEP_SUMMARY
      - name: Gate summary
        run: echo "release gate passed" >> $GITHUB_STEP_SUMMARY
