groups:
  - name: chain-health
    rules:
      - alert: ConvergenceLag
        expr: histogram_quantile(0.95, sum(rate(gossip_convergence_seconds_bucket[5m])) by (le)) > 30
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "Chain convergence p95 above 30s"
      - alert: ConsumerFeeComfortBreached
        expr: max_over_time(CONSUMER_FEE_P90[10m]) > on() param_change_active{key="ConsumerFeeComfortP90Microunits"}
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "Consumer fee p90 above comfort threshold"
      - alert: IndustrialDeferralRatioHigh
        expr: (increase(INDUSTRIAL_DEFERRED_TOTAL[10m]) / clamp_min(increase(INDUSTRIAL_ADMITTED_TOTAL[10m]) + increase(INDUSTRIAL_DEFERRED_TOTAL[10m]), 1)) > 0.3
        for: 20m
        labels:
          severity: warn
        annotations:
          summary: "Industrial deferral ratio above 30%"
      - alert: SubsidyGrowthSpike
        expr: increase(subsidy_cpu_ms_total[10m]) > 1e9 or increase(subsidy_bytes_total[10m]) > 1e12
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Subsidy counters growing unusually fast"
      - alert: ExplorerReadPayoutStalled
        expr: |
          (time() - explorer_block_payout_read_last_seen_timestamp{role!=""}) > 1800
            and on(role) (explorer_block_payout_read_total{role!=""} > 0)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Explorer read subsidy payouts stale for {{ $labels.role }}"
      - alert: ExplorerAdPayoutStalled
        expr: |
          (time() - explorer_block_payout_ad_last_seen_timestamp{role!=""}) > 1800
            and on(role) (explorer_block_payout_ad_total{role!=""} > 0)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Explorer advertising payouts stale for {{ $labels.role }}"
      - alert: RentEscrowLockedSpike
        expr: increase(rent_escrow_locked_ct_total[10m]) > 1e6
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Rent escrow locked CT spiking"
      - alert: TlsEnvWarningBurst
        expr: sum by (prefix, code)(increase(tls_env_warning_total[5m])) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "TLS environment warning detected for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningNewDetailFingerprint
        expr: increase(max by (prefix, code)(tls_env_warning_detail_unique_fingerprints)[10m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "New TLS detail fingerprint observed for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningNewVariablesFingerprint
        expr: increase(max by (prefix, code)(tls_env_warning_variables_unique_fingerprints)[10m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "New TLS variables fingerprint observed for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningDetailFingerprintFlood
        expr: sum by (prefix, code, fingerprint)(increase(tls_env_warning_detail_fingerprint_total{fingerprint!="none"}[5m])) > 10
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "TLS detail fingerprint {{ $labels.fingerprint }} surging for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningVariablesFingerprintFlood
        expr: sum by (prefix, code, fingerprint)(increase(tls_env_warning_variables_fingerprint_total{fingerprint!="none"}[5m])) > 10
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "TLS variables fingerprint {{ $labels.fingerprint }} surging for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningSnapshotsStale
        expr: tls_env_warning_stale_snapshots > 0
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "TLS warning snapshots stale beyond retention ({{ printf \"%.0f\" $value }} affected)"
      - alert: SelectionProofSnarkFallback
        expr: increase(ad_selection_attestation_total{kind="tee",result="fallback"}[10m]) > 0
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Selection proof falling back to TEE for {{ $value }} attestations"
      - alert: SelectionProofRejectionSpike
        expr: increase(ad_selection_attestation_total{result="rejected"}[5m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "Selection proof attestation rejected for {{ $value }} proofs"
      - alert: AdBudgetProgressFlat
        expr: |
          (max_over_time(ad_budget_progress[1h]) - min_over_time(ad_budget_progress[1h])) < 0.01
            and on (campaign) (max_over_time(ad_budget_progress[1h]) > 0.05)
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "Budget progress stalled for campaign {{ $labels.campaign }}"
  - name: dependency-registry
    rules:
      - alert: DependencyRegistryDriftDetected
        expr: max(dependency_registry_check_status{status="drift"}) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "Dependency registry drift detected ({{ $labels.detail }})"
      - alert: DependencyRegistryPolicyViolations
        expr: max(dependency_registry_check_status{status="violations"}) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "Dependency policy violations present; see dependency-violations.json"
      - alert: DependencyRegistryBaselineError
        expr: max(dependency_registry_check_status{status="baseline_error"}) > 0
        for: 1m
        labels:
          severity: page
        annotations:
          summary: "Dependency registry baseline failed to load"
      - alert: DependencyPolicyViolationSpike
        expr: increase(dependency_policy_violation_total[5m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "Dependency policy violations surfaced during latest check"
  - name: bridge
    rules:
      - alert: BridgeCounterDeltaSkew
        expr: |
          (bridge_metric_delta > avg_over_time(bridge_metric_delta[30m]) * 3)
            and (bridge_metric_delta > 10)
            and (count_over_time(bridge_metric_delta[30m]) >= 6)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Bridge counter delta skew detected for {{ $labels.metric }} on {{ $labels.peer }} ({{ $labels.labels }})"
      - alert: BridgeCounterRateSkew
        expr: |
          (bridge_metric_rate_per_second > avg_over_time(bridge_metric_rate_per_second[30m]) * 3)
            and (bridge_metric_rate_per_second > 0.5)
            and (count_over_time(bridge_metric_rate_per_second[30m]) >= 6)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Bridge counter rate skew detected for {{ $labels.metric }} on {{ $labels.peer }} ({{ $labels.labels }})"
      - alert: BridgeCounterDeltaLabelSkew
        expr: |
          (bridge_metric_delta{labels!=""} > avg_over_time(bridge_metric_delta{labels!=""}[30m]) * 3)
            and (bridge_metric_delta{labels!=""} > 5)
            and (count_over_time(bridge_metric_delta{labels!=""}[30m]) >= 6)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Bridge counter delta skew detected for {{ $labels.metric }} on {{ $labels.peer }} ({{ $labels.labels }})"
      - alert: BridgeCounterRateLabelSkew
        expr: |
          (bridge_metric_rate_per_second{labels!=""} > avg_over_time(bridge_metric_rate_per_second{labels!=""}[30m]) * 3)
            and (bridge_metric_rate_per_second{labels!=""} > 0.25)
            and (count_over_time(bridge_metric_rate_per_second{labels!=""}[30m]) >= 6)
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Bridge counter rate skew detected for {{ $labels.metric }} on {{ $labels.peer }} ({{ $labels.labels }})"
      - alert: BridgeRemediationAckPending
        expr: |
          sum by (action, playbook, target, state)(
            increase(bridge_remediation_dispatch_ack_total{target="http",state=~"pending|invalid"}[15m])
          ) > 0
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "Bridge remediation acknowledgements stalled ({{ $labels.state }}) for {{ $labels.action }} on target {{ $labels.target }}"
      - alert: BridgeRemediationAckLatencyHigh
        expr: |
          (
            histogram_quantile(
              0.95,
              sum by (le, playbook)(
                rate(bridge_remediation_ack_latency_seconds_bucket{state=~"acknowledged|closed"}[15m])
              )
            )
            /
            on (playbook) group_left () bridge_remediation_ack_target_seconds{phase="escalate"}
          ) > 1.0
            and on (playbook)
          (
            sum by (playbook)(
              increase(bridge_remediation_ack_latency_seconds_count{state=~"acknowledged|closed"}[15m])
            ) > 0
          )
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "Bridge remediation acknowledgement latency (p95) exceeds policy for {{ $labels.playbook }} ({{ printf \"%.2fx\" $value }} of target)"
      - alert: BridgeRemediationClosureMissing
        expr: |
          (
            sum by (action, playbook, target)(
              increase(bridge_remediation_dispatch_total{target="http",status="success"}[30m])
            )
            -
            sum by (action, playbook, target)(
              increase(bridge_remediation_dispatch_ack_total{target="http",state="closed"}[30m])
            )
          ) > 0
        for: 30m
        labels:
          severity: warn
        annotations:
          summary: "Bridge remediation closures missing for {{ $labels.action }} on target {{ $labels.target }}"
  - name: treasury
    rules:
      - alert: TreasuryDisbursementSnapshotStale
        expr: treasury_disbursement_snapshot_age_seconds > 900
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Treasury disbursement snapshot stale (age {{ printf \"%.0f\" $value }}s)"
      - alert: TreasuryDisbursementScheduleOverdue
        expr: treasury_disbursement_scheduled_oldest_age_seconds > 7200
        for: 15m
        labels:
          severity: page
        annotations:
          summary: "Oldest scheduled treasury disbursement pending for {{ printf \"%.0f\" $value }} seconds"
  - name: ad_readiness
    rules:
      - alert: AdReadinessUtilizationDelta
        expr: |
          max_over_time(abs(ad_readiness_utilization_delta_ppm)[15m]) > 100000
        for: 15m
        labels:
          severity: page
        annotations:
          summary: "Ad cohort utilization drift exceeds 10% for {{ $labels.domain }} (provider {{ $labels.provider }}, badges {{ $labels.badges }})"
