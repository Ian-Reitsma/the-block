groups:
  - name: chain-health
    rules:
      - alert: ConvergenceLag
        expr: histogram_quantile(0.95, sum(rate(gossip_convergence_seconds_bucket[5m])) by (le)) > 30
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "Chain convergence p95 above 30s"
      - alert: ConsumerFeeComfortBreached
        expr: max_over_time(CONSUMER_FEE_P90[10m]) > on() param_change_active{key="ConsumerFeeComfortP90Microunits"}
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "Consumer fee p90 above comfort threshold"
      - alert: IndustrialDeferralRatioHigh
        expr: (increase(INDUSTRIAL_DEFERRED_TOTAL[10m]) / clamp_min(increase(INDUSTRIAL_ADMITTED_TOTAL[10m]) + increase(INDUSTRIAL_DEFERRED_TOTAL[10m]), 1)) > 0.3
        for: 20m
        labels:
          severity: warn
        annotations:
          summary: "Industrial deferral ratio above 30%"
      - alert: SubsidyGrowthSpike
        expr: increase(subsidy_cpu_ms_total[10m]) > 1e9 or increase(subsidy_bytes_total[10m]) > 1e12
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Subsidy counters growing unusually fast"
      - alert: RentEscrowLockedSpike
        expr: increase(rent_escrow_locked_ct_total[10m]) > 1e6
        for: 10m
        labels:
          severity: warn
        annotations:
          summary: "Rent escrow locked CT spiking"
      - alert: TlsEnvWarningBurst
        expr: sum by (prefix, code)(increase(tls_env_warning_total[5m])) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "TLS environment warning detected for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningNewDetailFingerprint
        expr: increase(max by (prefix, code)(tls_env_warning_detail_unique_fingerprints)[10m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "New TLS detail fingerprint observed for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningNewVariablesFingerprint
        expr: increase(max by (prefix, code)(tls_env_warning_variables_unique_fingerprints)[10m]) > 0
        for: 5m
        labels:
          severity: warn
        annotations:
          summary: "New TLS variables fingerprint observed for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningDetailFingerprintFlood
        expr: sum by (prefix, code, fingerprint)(increase(tls_env_warning_detail_fingerprint_total{fingerprint!="none"}[5m])) > 10
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "TLS detail fingerprint {{ $labels.fingerprint }} surging for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningVariablesFingerprintFlood
        expr: sum by (prefix, code, fingerprint)(increase(tls_env_warning_variables_fingerprint_total{fingerprint!="none"}[5m])) > 10
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "TLS variables fingerprint {{ $labels.fingerprint }} surging for {{ $labels.prefix }} ({{ $labels.code }})"
      - alert: TlsEnvWarningSnapshotsStale
        expr: tls_env_warning_stale_snapshots > 0
        for: 15m
        labels:
          severity: warn
        annotations:
          summary: "TLS warning snapshots stale beyond retention ({{ printf \"%.0f\" $value }} affected)"
